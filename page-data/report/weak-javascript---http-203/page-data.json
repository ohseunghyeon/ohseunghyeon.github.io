{"componentChunkName":"component---src-templates-blog-post-js","path":"/report/weak-javascript---http-203/","result":{"data":{"site":{"siteMetadata":{"title":"Lazy Nyaong"}},"markdownRemark":{"id":"d65596c9-8a64-557f-9a4e-94825771d346","excerpt":"use case for weakMap, weakSet Let’s say you need to save some data related to a dom node, you stored the data in the node object But this is a bad practice…","html":"<h2 id=\"use-case-for-weakmap-weakset\" style=\"position:relative;\"><a href=\"#use-case-for-weakmap-weakset\" aria-label=\"use case for weakmap weakset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>use case for weakMap, weakSet</h2>\n<p>Let’s say you need to save some data related to a dom node, you stored the data in the node object</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> profile <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".user-profile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> profile<span class=\"token punctuation\">.</span>_internal<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span> <span class=\"token comment\">// BAD!</span></code></pre></div>\n<p>But this is a bad practice Because</p>\n<ul>\n<li>it’s bad etiquette to transform objects that you don’t own</li>\n<li>it can cause javascript runtime to deoptimize because changing the shape of an object will make generated binary code invalid</li>\n<li>it can cause name clash</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> auxilliaryData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> profile <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".user-profile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> auxilliaryData<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span>id<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Better!</span></code></pre></div>\n<p>If dom is gone, the value in weakMap will be gone too.</p>\n<p>You can use WeakSet in the same concept but to store boolean as value</p>\n<h2 id=\"weakref\" style=\"position:relative;\"><a href=\"#weakref\" aria-label=\"weakref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WeakRef</h2>\n<h3 id=\"gc\" style=\"position:relative;\"><a href=\"#gc\" aria-label=\"gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GC</h3>\n<p>In most of browsers, when to do GC or how to do GC is not specified on the spec. but It does it. when and how depends on the memory of machine. which means, if the machine has huge memory, GC would not happen for a long time. cause it happens when the machine lacks of memory.</p>\n<ul>\n<li>GC is non-obvious.</li>\n<li>One engine will GC differently from another engine.</li>\n<li>GC != Unreachable (reference to vars or objects)</li>\n<li>GC will happen late, or not at all(!)</li>\n</ul>\n<h3 id=\"how-to-use-weakref\" style=\"position:relative;\"><a href=\"#how-to-use-weakref\" aria-label=\"how to use weakref permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>how to use WeakRef</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> <span class=\"token function\">createAValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> weakRef <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakRef</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// typeof value === 'object'</span>\n<span class=\"token comment\">// -> Won't be GC'd until next task</span>\n<span class=\"token comment\">// ... later ...</span>\n<span class=\"token keyword\">const</span> maybeValue <span class=\"token operator\">=</span> weakRef<span class=\"token punctuation\">.</span><span class=\"token function\">deref</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maybeValue <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// value was GC'd</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// value is still available</span>\n  <span class=\"token comment\">// and won't be GC'd until next task</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"finalizationregistry-i-dont-understand-about-this-thing-at-all\" style=\"position:relative;\"><a href=\"#finalizationregistry-i-dont-understand-about-this-thing-at-all\" aria-label=\"finalizationregistry i dont understand about this thing at all permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FinalizationRegistry (I don’t understand about this thing at all)</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> registry <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FinalizationRegistry</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">heldValue</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// .. cleanup work ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nregistry<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>someValue<span class=\"token punctuation\">,</span> <span class=\"token string\">\"this is the held value\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Finalizer callback:</span>\n<span class=\"token comment\">// - someValue is already unavailable</span>\n<span class=\"token comment\">// - No guarantee it will run</span>\n<span class=\"token comment\">// - Especially unlikely to run if the tab is closed</span>\n<span class=\"token comment\">// - Or if the registry itself becomes unreachable</span>\n\n<span class=\"token keyword\">const</span> unregisterToken <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/*...*/</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nregistry<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>\n  someValue<span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"this is the held value\"</span><span class=\"token punctuation\">,</span>\n  unregisterToken\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","tableOfContents":"<ul>\n<li><a href=\"/report/weak-javascript---http-203/#use-case-for-weakmap-weakset\">use case for weakMap, weakSet</a></li>\n<li>\n<p><a href=\"/report/weak-javascript---http-203/#weakref\">WeakRef</a></p>\n<ul>\n<li><a href=\"/report/weak-javascript---http-203/#gc\">GC</a></li>\n<li><a href=\"/report/weak-javascript---http-203/#how-to-use-weakref\">how to use WeakRef</a></li>\n<li><a href=\"/report/weak-javascript---http-203/#finalizationregistry-i-dont-understand-about-this-thing-at-all\">FinalizationRegistry (I don’t understand about this thing at all)</a></li>\n</ul>\n</li>\n</ul>","timeToRead":2,"frontmatter":{"title":"Weak JavaScript - HTTP 203","date":"September 07, 2020","description":"weakMap, weakSet, weakRefs","category":"report","creator":"Google Chrome Developers","created_at":"2020-09-01T00:00:00.000Z","link":"https://www.youtube.com/watch?v=uygxJ8Wxotc"}}},"pageContext":{"slug":"/report/weak-javascript---http-203/","previous":{"fields":{"slug":"/report/2020-4-3/"},"frontmatter":{"title":"2020년 4월 셋째 주","category":"report"}},"next":{"fields":{"slug":"/report/software-engineering-best-practices/"},"frontmatter":{"title":"Software Engineering \"Best Practices\"","category":"report"}}}},"staticQueryHashes":["2718815002","452372368","63159454"]}